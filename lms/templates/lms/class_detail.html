{% extends 'lms/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h4>{{ class.course.name }} ({{ class.course.code }})</h4>
            </div>
            <div class="card-body">
                <p><strong>Викладач:</strong> {{ class.professor.user.get_full_name }}</p>
                <p><strong>Семестр:</strong> {{ class.semester }}</p>
                <p><strong>Розклад:</strong> {{ class.schedule }}</p>
                <p><strong>Аудиторія:</strong> {{ class.classroom }}</p>
                <p><strong>Кредити:</strong> {{ class.course.credits }}</p>
                <p><strong>Опис:</strong> {{ class.course.description }}</p>

                <!-- Додаємо кнопку запису для студентів -->
                {% if is_student and not is_enrolled %}
                <div class="mt-3">
                    <form action="{% url 'enroll_course' class.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success">Записатися на курс</button>
                    </form>
                </div>
                {% elif is_enrolled %}
                <div class="mt-3">
                    <div class="alert alert-info">Ви вже записані на цей курс.</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Блок для матеріалів курсу -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Матеріали курсу</h5>
                {% if is_professor %}
                <a href="{% url 'upload_material' class.id %}" class="btn btn-sm btn-primary">Додати матеріал</a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if materials %}
                <div class="list-group">
                    {% for material in materials %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ material.title }}</h6>
                            <small>{{ material.uploaded_at|date:"d.m.Y" }}</small>
                        </div>
                        {% if material.description %}
                        <p class="mb-1">{{ material.description }}</p>
                        {% endif %}
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                {% if material.file.name|slice:"-4:" == ".pdf" %}PDF документ
                                {% elif material.file.name|slice:"-4:" == ".zip" %}ZIP архів
                                {% elif material.file.name|slice:"-5:" == ".docx" %}Word документ
                                {% elif material.file.name|slice:"-4:" == ".ppt" or material.file.name|slice:"-5:" == ".pptx" %}Презентація
                                {% elif material.file.name|slice:"-4:" == ".xls" or material.file.name|slice:"-5:" == ".xlsx" %}Таблиця
                                {% else %}{{ material.file.name|slice:"-4:"|upper }} файл
                                {% endif %}
                                • {{ material.file.size|filesizeformat }}
                            </small>
                            <div>
                                {% if material.file %}
                                <a href="{{ material.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank" download>Завантажити</a>
                                {% if is_professor %}
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ material.id }}">
                                    Видалити
                                </button>
                                {% endif %}
                                {% else %}
                                <span class="text-danger">Файл відсутній</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Модальне вікно підтвердження видалення -->
                    {% if is_professor %}
                    <div class="modal fade" id="deleteModal{{ material.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ material.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteModalLabel{{ material.id }}">Підтвердження видалення</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Ви впевнені, що хочете видалити матеріал "{{ material.title }}"?</p>
                                    <p class="text-muted">Цю дію не можна буде скасувати.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                                    <form action="{% url 'delete_material' material.id %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger">Видалити</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">Матеріали відсутні.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        {% if is_professor %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>Керування курсом</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'professor_grades' class.id %}" class="btn btn-warning">Введення оцінок</a>
                    <a href="{% url 'class_assignments' class.id %}" class="btn btn-info">Завдання та роботи</a>
                    <button class="btn btn-info">Перегляд відвідуваності</button>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <h5>Студенти курсу</h5>
            </div>
            <div class="card-body">
                {% if enrollments %}
                <div class="list-group">
                    {% for enrollment in enrollments %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{{ enrollment.student.user.get_full_name }}</h6>
                            <small class="text-muted">{{ enrollment.student.student_id }}</small>
                        </div>
                        {% if enrollment.grade %}
                        <span class="badge bg-primary rounded-pill">{{ enrollment.grade }}</span>
                        {% else %}
                        <span class="badge bg-secondary rounded-pill">Не оцінено</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">На цей курс ще не записався жоден студент.</p>
                {% endif %}
            </div>
        </div>

        {% if not is_professor and not is_enrolled and not is_student %}
        <div class="card mt-4">
            <div class="card-body text-center">
                <h5>Запис на курс</h5>
                <p>Тільки студенти можуть записуватися на курси.</p>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">На головну</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}